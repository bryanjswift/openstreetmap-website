<% content_for :head do %>
  <%= javascript_include_tag "story", "jquery.simplemodal.1.4.4.min" %>
<% end %>


<%= error_messages_for 'story' %>

<%= form_for(@story) do |f| %>
  <div class="diary_entry standard-form">
    <fieldset>
      <div class='form-row'>
        <label class="standard-label"><%= t 'story.form.title' -%></label>
        <%= f.text_field :title, :class => "richtext_title" %>
      </div>
      <div class='form-row'>
        <label class="standard-label"><%= t 'story.form.layout' -%></label>
        <%= f.text_field :layout, :class => "richtext_title", :value => "project"  %>
      </div>
      <div class='form-row'>
        <label class="standard-label"><%= t 'story.form.language' -%></label>
        <%= f.text_field :language, :class => "richtext_title", :value => "en" %>
      </div>
      <div class='form-row'>
        <label class="standard-label"><%= t 'story.form.image_url' -%></label>
        <%= f.text_field :image_url, :class => "richtext_title", :value => "http://farm4.staticflickr.com/3687/12483987584_3b2a7cf09a_b.jpg"%>
      </div>

      <div class='form-row'>
        <label class="standard-label"><%= t 'story.form.description' -%></label>
        <%= richtext_area :story, :description, :cols => 80, :rows => 12, :format => "markdown" %>
      </div>

      <fieldset class='location'>
        <label class="standard-label"><%= t 'story.form.location' -%></label>
        <div><%= t 'story.form.location_hint' -%></div>
       
        <div class='form-row clearfix' />
          <div class='form-column'>
            <label class="secondary standard-label"><%= t 'story.form.latitude' -%></label>
            <%= f.text_field :latitude, :size => 20, :id => "latitude", :value => "-2.877" %>
          </div>
          <div class='form-column'>
            <label class="secondary standard-label"><%= t 'story.form.longitude' -%></label>
            <%= f.text_field :longitude, :size => 20, :id => "longitude", :value => "22.83" %>
          </div>
          <div class='form-column'>
            <label class="secondary standard-label"><%= t 'story.form.zoom' -%></label>
            <%= f.text_field :zoom, :size => 20, :id => "zoom", :value => "5" %>
          </div>
      </fieldset>
      

      <%= content_tag "div", "", :id => "initial_map", :data => {:lat => @lat, :lon => @lon, :zoom => @zoom} %>

      <div>
        <label class="standard-label"><%= t 'story.form.layers' -%></label>
        <%= f.select(:layers, options_from_collection_for_select(Tile.overlays, 'keyid', 'name', @story.layers.keys), {}, {:multiple => true, :size=> "8"} ) %>        
        <%= t 'story.form.layers_hint' %>
      </div>
      
      <%= hidden_field_tag "story[layers_status]", @story.layers.select{|k,v| v == true}.keys.join(",") %> 
      <hr />
      

      
      <% @story.body.each do |key, tab|
        next if key == "layers"
      %>
        <div class="sections sections_<%=key %>" >
            <label class="standard-label"><%= tab["title"]-%></label>
            <%= hidden_field_tag "story[body][#{key}][title]", tab["title"] %>
            <% tab["sections"].each_with_index do | section, index | %>
              <div class="section">
                <label>Section <%= index+1 %></label>
                <div class='form-row'>
                  <%= label_tag "story[body][#{key}][sections][][title]", "#{t'story.form.title'}" %>
                  <%= text_field_tag "story[body][#{key}][sections][][title]", section["title"], :rows => 8, :class => "richtext_title" %>
                </div>

                <div class='form-row'>
                  <%= label_tag "story[body][#{key}][sections][][text]", "#{t'story.form.description'}" %>
                  <%= text_area_tag "story[body][#{key}][sections][][text]", section["text"], :rows => 8, :class => "richtext_title" %>
                </div>
                <% if key == "report" && index == 0 %>
                  <% t 'story.form.first_report_section' %>
                <% end %>
                <% if key == "report" && index > 0 %>
                  <div class="section_link">
                    <label class="standard-label"><%= t 'story.form.new_link'  %> </label>
                    <div class='form-row'>
                      <%= label_tag "story[body][#{key}][sections][][link]", "#{t 'story.form.link'}" %>
                      <%= text_field_tag "story[body][#{key}][sections][][link]", section["link"] , :class=>"link_input"   %>
                    </div>
                  </div>
                <% end %>
              </div>

            <% end #section/index%>

          </div>
      
         <% if key == "report" %>
           <%= t 'story.form.section_link_hint' %><input type="button" id="section_link_button" class="section_link" value="<%= t'story.form.section_add_button' %>">
         <% end %>

      <% end #key/tab %>

  
     
         <label class="standard-label"><%= t 'story.form.links' -%></label>
         <div id="links_map_box">
           <%= t 'story.form.modal_help' %>
           <%= content_tag "div", "", :id => "links_map", :data => {:lat => @lat, :lon => @lon, :zoom => @zoom} %> 
         </div>
         
           
           <div id="story_links">

             <% @story.body["sites"]["sections"][0]["links"].each_with_index do | link, i |
                next if link["title"]== "" && link["link"]==""
             %>
               <div class="story_link">
                 <label class="standard-label"><%= "#{t 'story.form.link'}: #{i+1}" -%></label>
                 <label class="standard-label"><%= t 'story.form.link_add_hint' -%></label>
                 <div class='form-row'>
                   <%= label_tag "story[body][sites][sections][][links][][title]", "#{t'story.form.title'}" %>
                   <%= text_field_tag "story[body][sites][sections][][links][][title]", link["title"]  %>
                   <%= label_tag "story[body][sites][sections][][links][][link]", "#{t'story.form.link'}" %>
                   <%= text_field_tag "story[body][sites][sections][][links][][link]", link["link"], :class=>"link_input"  %>
                 </div>
                 <div class='form-row'>
                   <%= label_tag "story[body][sites][sections][][links][][text]", "#{t'story.form.description'}" %>
                   <%= text_area_tag "story[body][sites][sections][][links][][text]", link["text"]  %>
                 </div>
               </div>
             <% end %>
           </div>
         <%= t 'story.form.links_hint' %><input type="button" id="story_link_button" class="story_link" value="<%= t'story.form.add_button' %>">

  
  </div>
  
      
      


      <div class='form-row'>
        <label class="standard-label"><%= t 'story.form.group' -%></label>
        <%= select(:story, :group_id, @user.groups.collect {|g| [g.title, g.id]}, { :include_blank => t('story.form.no_group') }) %>
      </div>      

    </fieldset>

    <% if @story.new_record? %> 
      <%= submit_tag t('story.form.save_button') %>
    <% else %>
      <%= submit_tag t('story.form.update_button') %>
    <% end %>

  </div>
<% end %>

<!-- template for adding extra label -->
<div id="story_link_template" >
  <div class="story_link">
    <label class="standard-label"><%= t 'story.form.new_link'  %> </label>
    <div class='form-row'>
      <%= label_tag "story[body][sites][sections][][links][][title]", "#{t 'story.form.title'}" %>
      <%= text_field_tag "story[body][sites][sections][][links][][title]"  %>
      <%= label_tag "story[body][sites][sections][][links][][link]", "#{t 'story.form.link'}" %>
      <%= text_field_tag "story[body][sites][sections][][links][][link]", nil , :class=>"link_input"   %>
    </div>
    <div class='form-row'>
      <%= label_tag "story[body][sites][sections][][links][][text]", "#{t 'story.form.description'}" %>
      <%= text_area_tag "story[body][sites][sections][][links][][text]"  %>
    </div>
  </div>
</div>
<!-- template for adding extra section -->
<div id="section_link_template" >
  <div class="section">
    <label><%= t 'form.story.new_section' %></label>
    <div class='form-row'>
      <%= label_tag "story[body][report][sections][][title]", "#{t'story.form.title'}" %>
      <%= text_field_tag "story[body][report][sections][][title]", nil, :rows => 8, :class => "richtext_title" %>
    </div>

    <div class='form-row'>
      <%= label_tag "story[body][report][sections][][text]", "#{t'story.form.description'}" %>
      <%= text_area_tag "story[body][report][sections][][text]", nil, :rows => 8, :class => "richtext_title" %>
    </div>
    <div class="section_link">
      <label class="standard-label"><%= t 'story.form.new_link'  %> </label>
      <div class='form-row'>
        <%= label_tag "story[body][report][sections][][link]", "#{t'story.form.link'}" %>
        <%= text_field_tag "story[body][report][sections][][link]",nil , :class=>"link_input"   %>
      </div>
    </div>
  </div>
</div>